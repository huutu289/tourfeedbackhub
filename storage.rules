/**
 * @file Firebase Storage Security Rules for TourFeedbackHub
 *
 * @security
 *  - Read access to public content is open.
 *  - Write access for tours is restricted to administrators.
 *  - Admin status is verified by checking for the user's UID in the `/admins` Firestore collection.
 */
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if a user is an admin by looking up their UID
    // in the /admins collection in Firestore.
    function isAdmin() {
      // Allow write if the user's UID exists as a document in the /admins collection.
      return request.auth != null && exists(/databases/(default)/documents/admins/$(request.auth.uid));
    }

    // Publicly readable content
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tour media: Publicly readable, but only writable by admins.
    match /tours/{tourId}/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Temporary upload storage for feedback (private, managed by Cloud Functions)
    match /uploads/tmp/{allPaths=**} {
      allow read, write: if false; // Accessed only via signed URLs
    }

    // Private admin-only content
    match /private/{allPaths=**} {
      allow read, write: if isAdmin();
    }

    // Deny all other paths by default.
    // This is a security best practice. If a path is not explicitly matched,
    // access is denied. This prevents accidental exposure of data.
    match /{path=**} {
      // Ensure we don't block paths that should be allowed.
      // This rule will not match any path already matched above.
      allow read, write: if false;
    }
  }
}
