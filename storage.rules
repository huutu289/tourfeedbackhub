/**
 * @file Firebase Storage Security Rules for TourFeedbackHub
 *
 * @structure
 *  - /public/** : Publicly readable content (hero images, tours, reviews)
 *  - /uploads/tmp/** : Temporary upload storage (private, auto-cleanup)
 *  - /private/** : Admin-only content
 *
 * @security
 *  - All write operations require admin authentication
 *  - Public content is readable by everyone
 *  - Temporary uploads are private and managed by Cloud Functions
 *  - File size and type validation enforced
 */

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is admin (using custom claims)
    function isAdmin() {
      return request.auth != null &&
        (
          request.auth.token.admin == true ||
          request.auth.token.role == 'admin'
        );
    }

    // Helper function to validate image files
    function isValidImage() {
      return request.resource.size < 10 * 1024 * 1024 // 10MB max
             && request.resource.contentType.matches('image/(jpeg|png|webp|heic|jpg)');
    }

    // Helper function to validate video files
    function isValidVideo() {
      return request.resource.size < 100 * 1024 * 1024 // 100MB max
             && request.resource.contentType.matches('video/(mp4|quicktime|x-msvideo|webm)');
    }

    /**
     * @description Public content (readable by anyone, writable by admins only)
     * @path /public/**
     */
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    /**
     * @description Tour media, publicly readable, writable by admins.
     */
    match /tours/{tourId}/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Slide images for hero carousel, publicly readable, writable by admins.
     */
    match /slides/{locale}/{fileName} {
      allow read: if true;
      allow write: if isAdmin() && isValidImage();
    }

    /**
     * @description Media library files (CMS uploads)
     * @path /media/**
     */
    match /media/{fileName} {
      allow read: if true; // Public read access

      // Allow authenticated users to upload
      allow create: if request.auth != null
                    && request.resource.size < 10 * 1024 * 1024
                    && (request.resource.contentType.matches('image/.*') ||
                        request.resource.contentType.matches('video/.*') ||
                        request.resource.contentType.matches('audio/.*') ||
                        request.resource.contentType == 'application/pdf');

      // Allow users to delete their own uploads or admins to delete any
      allow delete: if request.auth != null
                    && (isAdmin() || resource.metadata.uploadedBy == request.auth.uid);

      // Allow metadata updates
      allow update: if request.auth != null
                    && (isAdmin() || resource.metadata.uploadedBy == request.auth.uid);
    }

    /**
     * @description Temporary upload storage for feedback photos.
     * Only writable via signed URLs generated by the feedback-submit function.
     */
    match /uploads/tmp/{feedbackId}/{fileName} {
      allow read: if false; // No public read access
      allow write; // Allows writes via Signed URL
    }

    /**
     * @description Private admin-only content
     * @path /private/**
     */
    match /private/{allPaths=**} {
      allow read, write: if isAdmin();
    }

    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
